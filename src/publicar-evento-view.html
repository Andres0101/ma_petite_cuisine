<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../bower_components/google-map/google-map.html">

<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/paper-input-location/paper-input-location.html">
<link rel="import" href="../bower_components/paper-input-autocomplete-chips/paper-input-autocomplete-chips.html">

<link rel="import" href="elements/form-date-card.html">

<link rel="stylesheet" href="../bower_components/cropperjs/dist/cropper.css">
<script src="../bower_components/cropperjs/dist/cropper.js"></script>
<link rel="import" href="shared-styles.html">

<dom-module id="publicar-evento-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      .bg-header {
        position: absolute;
        width: 100%;
        height: 264px;
        padding: 8px 12px;
        box-sizing: border-box;
        background-color: var(--app-primary-color);
        color: #fff;
      }

      #title_logo{
        width: 170px;
        height: 42px;
      }
      #title_logo_icon{
        width: 45px;
        height: 40px;
        display: none;
      }

      #container{
        width: 95%;
        max-width: 800px;
        margin-top: 80px;
        will-change: transform;
      }

      #form_title{
        width: 100%;
        margin-bottom: 40px;
        color: white;
      }

      #form_title iron-icon{
        width: 44px;
        height: 44px;
        color: #222;
      }

      #card {
        width: 100%;
        background-color: white;
        border-radius: 2px;
        border-top: 3px solid var(--app-event-color);
        @apply(--shadow-elevation-2dp);
      }

      /*Secciones*/
      .info_section{
        padding: 20px;
      }
      .section_title{
        color: rgba(0, 0, 0, 0.75);
        margin: 12px 0;
      }
      .section_title iron-icon{
        margin-right: 12px;
      }
      .section_title div{
        font-weight: 500;
      }
      .info_row{
        @apply(--layout-horizontal);
      }
      .info_item{
        padding: 10px 5px;
      }
      .info_item_title{
        font-weight: 500;
        color: rgba(0, 0, 0, 0.7);
        margin-top: 12px;
      }
      .info_item p {
        width: 100%;
        max-width: 600px;
        color: #666;
      }

      /* Inputs */
      paper-input, paper-dropdown-menu, paper-textarea, paper-input-location{
        padding: 0px 4px;
        --paper-input-container-focus-color: var(--app-event-color);
      }
      paper-input-autocomplete-chips{
        padding-top: 4px;
        --paper-input-container-focus-color: var(--app-event-color);
      }
      .short_input{
        width: 90%;
        max-width: 220px;
      }
      .medium_input{
        width: 90%;
        max-width: 300px;
      }
      .large_input{
        width: 90%;
        max-width: 600px;
      }

      /* Vaadin upload */
      vaadin-upload{
        padding: 0;
        --primary-color: var(--app-event-color);
        --vaadin-upload-buttons-primary:{
          padding: 16px;
        }
        --vaadin-upload-button-add:{
          padding: .43em 1em;
          background-color: var(--app-event-color);
        }
        --vaadin-upload-file:{
          padding: 0;
        }
        --vaadin-upload-file-row:{
          padding: 0px 10px;
        }
      }
      .image_container{
        width: 100%;
        height: 300px;
        background-color: #F7F7F7;
      }
      .image_container iron-icon{
        width: 80px;
        height: 80px;
        color: #e1e1e1;
      }
      #cover_image{
        width: 100%;
        height: 100%;
        background-color: #F7F7F7;
      }

      #cropper_wrapper{
        width: 100%;
        height: 100%;
      }
      #cropper_image {
        max-width: 100%; /* This rule is very important, please do not ignore this! */
        max-height: 100%;
      }

      #dragToReposition{
        position: absolute;
        padding: 4px 8px;
        background-color: rgba(40, 40, 40, 0.8);
        color: white;
        border-radius: 2px;
        pointer-events: none;
      }
      #dragToReposition iron-icon{
        width: 24px;
        height: 24px;
        margin-right: 4px;
      }

      /*Categoías*/
      paper-checkbox.main_category {
        display: none;
      }

      /* Fechas */
      #add_new_card{
        position: relative;
        width: 242px;
        height: 258px;
        margin: 4px;
        background-color: #fdfdfd;
        color: #444;
        border: 1px solid #ebebeb;
        box-sizing: border-box;
      }
      #add_new_card iron-icon{
        width: 50px;
        height: 50px;
        color: var(--app-event-color);
        margin-bottom: 8px;
      }
      #add_new_card:hover{
        cursor: pointer;
        background-color: #fafafa;
      }

      /*Mapa*/
      #map_container{
        margin-top: 12px;
        width: 100%;
        height: 300px;
        background: url('../images/map_placeholder.svg') no-repeat center center;
      }
      google-map{
        width: 100%;
        height: 100%;
      }

      @media (max-width: 600px) {
        .info_section{
          padding: 10px;
        }
        .info_row{
          @apply(--layout-vertical);
        }
      }

      @media (max-width: 450px) {
        #form_title div {
          font-size: 24px;
          line-height: 26px;
        }
        #title_logo{
          display: none;
        }
        #title_logo_icon{
          display: inline-block;
        }
      }
    </style>

    <iron-ajax
      auto
      url="http://localhost:8000/api/v1/categories-activate"
      handle-as="json"
      last-response="{{categories}}">
    </iron-ajax>


    <div class="bg-header">
      <a href="/publicar" class="link">
        <paper-icon-button icon="arrow-back"></paper-icon-button>
      </a>
    </div>

    <div id="container" class="layout vertical center">
      <div id="form_title" class="layout horizontal center">
        <div class="paper-font-display1">Publicar un evento</div>
        <span class="flex"></span>
        <a href="/">
          <iron-image id="title_logo" src="../images/logo.svg" preload sizing="contain"></iron-image>
          <iron-image id="title_logo_icon" src="../images/logo_icon.svg" preload sizing="contain"></iron-image>
        </a>
      </div>

      <div id="card">
        <form is="iron-form" id="form" method="post" action="http://httpbin.org/post">
          <div class="info_section">
            <div class="info_row">
              <!-- Nombre -->
              <div class="info_item flex">
                <div class="section_title layout horizontal center">
                  <iron-icon icon="description"></iron-icon>
                  <div class="paper-font-subhead">Nombre</div>
                </div>
                <paper-input name="name" placeholder="Breakfast at Tiffany's" class="medium_input" no-label-float char-counter maxlength="70" required></paper-input>
              </div>
              <!-- Publicado por -->
              <div class="info_item flex">
                <div class="section_title layout horizontal center">
                  <iron-icon icon="editor:publish"></iron-icon>
                  <div class="paper-font-subhead">Publicado por</div>
                </div>
                <paper-dropdown-menu name="publisher" no-label-float class="short_input">
                  <paper-listbox class="dropdown-content" selected="0">
                    <paper-item>Alejandro Sanclemente</paper-item>
                    <!-- TODO: Obtener listado de establecimientos del usuario actual -->
                    <paper-item disabled>Mi restaurante</paper-item>
                    <paper-item disabled>Mi discoteca</paper-item>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
            </div>

            <!-- Imagen -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="image:image"></iron-icon>
                <div class="paper-font-subhead">Imagen</div>
              </div>
              <input type="text" name="cover_image" value="{{coverImage}}" hidden>
              <vaadin-upload
                id="cover_upload"
                accept="image/*"
                i18n="{{vaadinLocalize}}"
                max-files="1"
                target="http://httpbin.org/post"
                on-file-reject="_fileRejected"
                on-file-abort="_fileAborted"
                on-upload-before="_uploadRequested"
                on-upload-success="_uploadSucceded">

                  <template is="dom-if" if="{{!uploadingDone}}">
                    <template is="dom-if" if="{{!uploadingImage}}">
                      <div class="image_container layout vertical center-center">
                        <iron-icon icon="image:add-a-photo"></iron-icon>
                      </div>
                    </template>
                    <template is="dom-if" if="{{uploadingImage}}">
                      <div class="image_container layout vertical center-center">
                        <paper-spinner active></paper-spinner>
                      </div>
                    </template>
                  </template>
                  <div class="image_container layout vertical center-center" hidden$="{{!uploadingDone}}">
                    <div id="cropper_wrapper">
                      <img id="cropper_image">
                    </div>
                    <div id="dragToReposition">
                      <iron-icon icon="open-with"></iron-icon>
                      Arrastra para ajustar
                    </div>
                  </div>
              </vaadin-upload>
            </div>

            <!-- Descripción -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="description"></iron-icon>
                <div class="paper-font-subhead">Descripción</div>
              </div>
              <paper-textarea name="description" placeholder="Ingresa información del evento..." class="large_input" rows="4" no-label-float char-counter maxlength="1000" required></paper-textarea>
            </div>

            <div class="info_row">
              <!-- Categoría principal -->
              <div class="info_item flex">
                <div class="section_title layout horizontal center">
                  <iron-icon icon="description"></iron-icon>
                  <div class="paper-font-subhead">Categoría principal</div>
                </div>

                <paper-dropdown-menu name="main_category" no-label-float class="short_input" placeholder="Selecciona una categoría">
                  <paper-listbox class="dropdown-content" selected="{{mainCategory}}" attr-for-selected="name">
                    <template is="dom-repeat" items="{{categories.response}}" as="category">
                      <paper-item name="{{category.slug}}">{{category.name}}</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>

              <!-- Categorías secundarias -->
              <template is="dom-if" if="{{mainCategory}}" restamp="true">
                <div class="info_item flex">
                  <div class="section_title layout horizontal center">
                    <iron-icon icon="description"></iron-icon>
                    <div class="paper-font-subhead">Categorías secundarias</div>
                  </div>
                  <div id="category_checkboxes">
                    <iron-selector selected="[[mainCategory]]" attr-for-selected="name" selected-class="main_category" class="layout vertical">
                      <template is="dom-repeat" items="{{categories.response}}" as="category">
                        <paper-checkbox name="{{category.slug}}">{{category.name}}</paper-checkbox>
                      </template>
                    </iron-selector>
                  </div>
                </div>
              </template>
            </div>

          </div>

          <hr>

          <div class="info_section">
            <!-- Días del evento -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="event"></iron-icon>
                <div class="paper-font-subhead">Días del evento</div>
              </div>

              <div id="dates_container" class="layout horizontal wrap">
                <form-date-card></form-date-card>
                <div id="add_new_card" class="layout vertical center-center" on-tap="_addDateCard">
                  <iron-icon icon="add-circle"></iron-icon>
                  <div class="noselect paper-font-body1">Agregar día</div>
                  <paper-ripple></paper-ripple>
                </div>
              </div>
            </div>
          </div>

          <hr>

          <div class="info_section">
            <!-- Ubicación en el mapa -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="maps:map"></iron-icon>
                <div class="paper-font-subhead">Ubicación en el mapa</div>
              </div>

              <paper-input-location id="inputLocation" label="Buscar en el mapa..." latitude="{{defaultLat}}" longitude="{{defaultLng}}" options="{{autocompleteOptions}}" on-place-clicked="_placeSelected" class="medium_input" maps-api-key="AIzaSyD2pssWo-hYkpweONkIKheKGp8A06XXSAM"></paper-input-location>

              <div id="map_container" class="layout vertical center-center">
                <google-map latitude="[[defaultLat]]" longitude="[[defaultLng]]" zoom="15" api-key="AIzaSyD2pssWo-hYkpweONkIKheKGp8A06XXSAM">
                  <google-map-marker draggable="true" latitude="[[defaultLat]]" longitude="[[defaultLng]]"></google-map-marker>
                </google-map>
              </div>
            </div>
            <div class="info_row">
              <!-- Dirección -->
              <div class="info_item flex">
                <div class="section_title layout horizontal center">
                  <iron-icon icon="maps:place"></iron-icon>
                  <div class="paper-font-subhead">Dirección</div>
                </div>
                <paper-input name="address" class="medium_input" placeholder="Carrera 2 # 24-46"></paper-input>

              </div>
              <!-- Teléfonos -->
              <div class="info_item flex">
                <div class="section_title layout horizontal center">
                  <iron-icon icon="maps:local-phone"></iron-icon>
                  <div class="paper-font-subhead">Teléfonos</div>
                </div>
                <!-- TODO: Obtener chips con la propiedad selectedObjects -->
                <paper-input-autocomplete-chips
                  class="medium_input"
                  auto-validate
                  no-label-float
                  no-chip-image
                  label="5555555, 3001234567..."
                  placeholder-after-selected="Máximo 5 teléfonos"
                  max-selected-items="5"
                  allowed-pattern="[0-9]"
                  pattern="^(\d{7}|\d{10})?$"
                  maxlength="10"
                  error-message="Ingresa un teléfono válido"
                  token-accept-key-codes="32,188"
                  allow-select-unknown-token>
                </paper-input-autocomplete-chips>
              </div>
            </div>
          </div>

          <hr>

          <div class="info_section">
            <!-- Galería de imágenes -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="image:image"></iron-icon>
                <div class="paper-font-subhead">Galería de imágenes (opcional)</div>
              </div>
              <vaadin-upload
                accept="image/*"
                i18n="{{vaadinLocalize}}"
                max-files="10"
                target="http://httpbin.org/post">
              </vaadin-upload>
            </div>
          </div>

          <hr>

          <div class="info_section">
            <!-- Videos -->
            <div class="info_item">
              <div class="section_title layout horizontal center">
                <iron-icon icon="maps:local-movies"></iron-icon>
                <div class="paper-font-subhead">Videos (opcional)</div>
              </div>
              <paper-input-autocomplete-chips
                selected-objects="[[videoObjects]]"
                class="large_input"
                auto-validate
                no-label-float
                label="Ingresa links de YouTube"
                placeholder-after-selected="Máximo 4 videos"
                max-selected-items="4"
                pattern="^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$"
                error-message="Ingresa un link de YouTube válido"
                token-accept-key-codes="32,188"
                allow-select-unknown-token
                on-selecting-object="_getVideoInfo" >
              </paper-input-autocomplete-chips>

            </div>
          </div>

        </form>
      </div>
    </div>

    <paper-toast id="toast"></paper-toast>

  </template>

  <script>
    Polymer({
      is: 'publicar-evento-view',
      attached: function () {
        this.videoObjects = [];
        this.uploadingImage = false;
        this.uploadingDone = false;
        this.vaadinLocalize = {
          dropFiles: {
            one: 'Arrastra una imagen aquí...',
            many: 'Hasta 10 imágenes'
          },
          addFiles: {
            one: 'Examinar',
            many: 'Subir archivos'
          },
          cancel: 'Cancelar',
          error: {
            tooManyFiles: 'No es posible subir más archivos',
            fileIsTooBig: 'El archivo es muy pesado',
            incorrectFileType: 'Tipo de archivo no permitido'
          },
          uploading: {
            status: {
              connecting: 'Conectando...',
              stalled: 'Detenido',
              processing: 'Procesando imagen...'
            },
            remainingTime: {
              prefix: 'tiempo restante: ',
              unknown: 'tiempo restante desconocido'
            },
            error: {
              serverUnavailable: 'Servidor no disponible',
              unexpectedServerError: 'Error inesperado del servidor',
              forbidden: 'Servidor no disponible'
            }
          },
          units: {
            size: ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
          }
        }

        this.defaultLat = 3.451719;
        this.defaultLng = -76.532120;

        this.autocompleteOptions = {
          componentRestrictions:{
            country:'co'
          }
        }
      },
      _fileRejected: function (event) {
        this.$.toast.text = event.detail.file.name + ' error: ' + event.detail.error;
        this.$.toast.open();
      },
      _fileAborted: function () {
        this.uploadingImage = false;
        this.uploadingDone = false;
      },
      _uploadRequested: function (event) {
        this.uploadingImage = true;

        // Prevents the uploading request
        event.preventDefault();

        var self = this;
        var reader = new FileReader();

        reader.onload = function(e) {
          self.uploadingDone = true;
          //Marcar como completada la subida
          self.$.cover_upload.set(['files', self.$.cover_upload.files.indexOf(event.detail.file), 'progress'], 100);
          self.$.cover_upload.set(['files', self.$.cover_upload.files.indexOf(event.detail.file), 'complete'], true);

          var image = self.$.cropper_image;
          cropper = new Cropper(image, {
            viewMode: 3,
            dragMode: "move",
            autoCropArea: 1,
            cropBoxMovable: false,
            background: false,
            guides: false,
            center: false,
            scalable: false,
            rotatable: false,
            cropBoxResizable: false,
            toggleDragModeOnDblclick: false,
            cropmove: function () {
              self.$.dragToReposition.style.display = "none";
            }
          });
          cropper.replace(e.target.result);

          // Retorna la imagen en base64. TODO: Llamar esta función al enviar el formulario
          // this.coverImage = cropper.getCroppedCanvas().toDataURL();

          image.addEventListener('zoom', function (e) {
            // Prevenir zoom si el tamaño es mayor a la imagen original
            if (e.detail.ratio > 1) {
              e.preventDefault();
            }
          });
        };
        reader.readAsDataURL(event.detail.file);
      },
      _addDateCard: function () {
        var dateCard = document.createElement("form-date-card");
        dates_container.insertBefore(dateCard, this.$.add_new_card);
      },
      _placeSelected: function () {
        this.$.inputLocation.query = "";
      },
      _getVideoInfo: function (e) {
        e.preventDefault();

        var videoUrl = e.detail.selectedObject.text;
        var videoId = this._getVideoIdFromUrl(videoUrl);

        var self = this;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            var selectedItem = {
                key: videoUrl,
                text: response.items[0].snippet.title,
                imgUrl: response.items[0].snippet.thumbnails.default.url
            };
            if (self._findObjectAlreadySelected(selectedItem) < 0) {
              self.push('videoObjects', selectedItem);
            } else{
              self.$.toast.text = "Ya agregaste este video";
              self.$.toast.open();
            }
          }
        };
        xhttp.open("GET", "https://www.googleapis.com/youtube/v3/videos?id=" + videoId + "&key=AIzaSyD2pssWo-hYkpweONkIKheKGp8A06XXSAM&part=snippet", true);
        xhttp.send();
      },
      _getVideoIdFromUrl: function (url) {
        var videoId = "";
        var regExp = /(?:https?:\/{2})?(?:w{3}\.)?youtu(?:be)?\.(?:com|be)(?:\/watch\?v=|\/)([^\s&]+)/;
        var match = url.match(regExp);

        //YouTube
        if (match && match[1].length==11) {
          videoId = match[1];
        }
        return videoId;
      },
      _findObjectAlreadySelected: function (objValue) {
        if (!objValue) { return -1; }

        var i = (this.videoObjects) ? this.videoObjects.length : 0;
        while (i--) {
          var objToCompare = this.videoObjects[i];
          if (objToCompare.key === objValue.key) return i;
        }
        return -1;
      }
    });
  </script>
</dom-module>
