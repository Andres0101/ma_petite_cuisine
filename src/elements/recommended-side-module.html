<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="plan-card.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="recommended-side-module">
  <template>
    <style include="shared-styles">
      :host{
        position: relative;
        margin-left: 24px;
        width: 300px;
        min-width: 250px;
      }
      #recommended_box{
        width: 100%;
        box-sizing: border-box;
        background-color: white;
        @apply(--shadow-elevation-2dp);
        border-radius: 2px;
        overflow: hidden;
      }

      .recommended_item{
        --plan-card: {
          @apply(--layout-horizontal);
          @apply(--shadow-none);
        }
        --plan-card-hover:{
          @apply(--shadow-none);
        }
        --plan-card-content:{
          padding: 10px;
        }
        --plan-card-image: {
          background-color: #eee;
          min-width: 83px;
          height: auto;
        }
        --plan-card-title:{
          font-size: 14px;
        }
        --plan-card-description:{
          margin: 0;
          font-size: 12px;
        }
        --plan-card-date:{
          font-size: 12px;
        }
        --plan-card-location:{
          margin-top: 0;
          font-size: 12px;
        }
      }

      .section_title{
        color: rgba(0, 0, 0, 0.75);
        margin: 12px 0;
        padding: 6px 12px;
      }
      .section_title iron-icon{
        margin-right: 12px;
      }
      .section_title div{
        font-weight: 500;
      }

      @media (max-width: 1100px) {
        :host{
          margin-left: 12px;
        }
      }

      @media (max-width: 900px) {
        :host{
          width: 100%;
          min-width: 0;
          margin: 0;
          margin-top: 24px;
        }
      }
    </style>

    <div id="recommended_box">
      <div class="section_title layout horizontal center">
        <iron-icon icon="{{icon}}"></iron-icon>
        <div class="paper-font-subhead">{{title}}</div>
      </div>
      <hr>
      <template is="dom-repeat" items="[[relatedItems]]" as="items">
        <plan-card
          cell
          class="recommended_item"
          contentype="[[items.content_type]]"
          title="[[items.name]]"
          date="[[items.date]]"
          url="[[items.click_url]]"
          image="[[items.url_img]]"
          rating="[[items.recs-pep-ranking-register]]"
          description="[[items.description]]"
          location="[[items.location]]">
        </plan-card>
      </template>
    </div>

  </template>

  <script>
    Polymer({
      is: 'recommended-side-module',

      properties: {
        title: String,
        icon: String,
        type: String,
        relatedItems: {
          type: Object,
          value: []
        }
      },

      ready: function () {
        var self = this;
        generateCxense(this.type);

        // Listener para saber cuando Cxense obtuvo los datos para los widgets
        window.addEventListener('cxenseReadySingle', function () {
          var recommendedItems = window.relatedArray;
          self.relatedItems = recommendedItems;
        })
      }
    });
  </script>

  <!-- Cxense -->
  <script>
    var WIDGET_SINGLE = 'dfff99767bfb0fe270aa24608562b89b0c0bf73c';

    var relatedArray = [];

    var cX = cX || {};
    cX.callQueue = cX.callQueue || [];

    function generateCxense(type) {
      // Request
      cX.callQueue.push(['insertWidget', {
        widgetId: WIDGET_SINGLE,
        renderFunction: render
      },
      {
        context: {
          "parameters": [{"key": "userquery", "value": type}]
        }
      }]);
    }

    function render(data, context) {
      relatedArray = data.response.items;

      for (var i = 0; i < relatedArray.length; i++) {
        if (relatedArray[i]['recs-pep-type-register'] == 'restaurant') {
          relatedArray[i]['name_entity'] = 'restaurante';
          relatedArray[i]['type'] = 'place';
          relatedArray[i]['content_type'] = 'restaurant';
        } else if (relatedArray[i]['recs-pep-type-register'] == 'bar') {
          relatedArray[i]['name_entity'] = 'bar';
          relatedArray[i]['type'] = 'place';
          relatedArray[i]['content_type'] = 'bar-disco';
        } else if (relatedArray[i]['recs-pep-type-register'] == 'discos') {
          relatedArray[i]['name_entity'] = 'discoteca';
          relatedArray[i]['type'] = 'place';
          relatedArray[i]['content_type'] = 'bar-disco';
        } else {
          relatedArray[i]['name_entity'] = 'eventos';
          relatedArray[i]['type'] = 'event';
          relatedArray[i]['content_type'] = 'event';
        }

        // Validar si la imagen termia con 200x200.jpg
        if (!relatedArray[i]['recs-pep-image-thumbnail'].endsWith("200x200.jpg") && !relatedArray[i]['recs-pep-image-thumbnail'].endsWith("400x400.jpg")) { // Si no, entonces lo agrega
          relatedArray[i]['recs-pep-image-thumbnail'] = relatedArray[i]['recs-pep-image-thumbnail'].replace(".jpg", "200x200.jpg");
        }

        relatedArray[i]['name'] = relatedArray[i]['recs-pep-title-register'];
        relatedArray[i]['url_img'] = relatedArray[i]['recs-pep-image-thumbnail'];
        // relatedArray[i]['date'] = relatedArray[i]['recs-pep-date-month'];
        relatedArray[i]['description'] = relatedArray[i]['recs-pep-description-register'];
        relatedArray[i]['location'] = relatedArray[i]['recs-pep-place'];

        delete relatedArray[i]['recs-pep-image-thumbnail'];
        delete relatedArray[i]['recs-pep-title-register'];
        // delete relatedArray[i]['recs-pep-date-month'];
        delete relatedArray[i]['recs-pep-description-register'];
        delete relatedArray[i]['recs-pep-place'];
      }

      var event = new Event('cxenseReadySingle');
      window.dispatchEvent(event);
    }
  </script>
</dom-module>
