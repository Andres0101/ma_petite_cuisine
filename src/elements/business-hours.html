<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="business-hours">
  <template>
    <style include="shared-styles">
      :host{
        display: block;
        padding: 4px 0;
      }

      .sucursal_hours iron-icon {
        width: 20px;
        height: 20px;
      }
      .sucursal_hours iron-icon:first-child {
        margin-right: 6px;
      }

      paper-menu-button{
        padding: 2px 4px;
        border: 1px solid #ddd;
        border-radius: 24px;
        --paper-menu-button-dropdown:{
          width:180px;
        }
      }
      paper-menu-button:hover{
        background-color: #f8f8f8;
      }
      .dropdown-content{
        padding: 12px;
      }

      .title{
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .day_name{
        margin-top: 8px;
      }
      .day_name:first-child{
        margin-top: 0;
      }

      .yellow{
        color: var(--paper-amber-600);
      }
      .green{
        color: var(--paper-green-a700);
      }
      .grey{
        color: var(--paper-grey-600);
      }
      .red{
        color: var(--paper-red-600);
      }

    </style>

    <paper-menu-button>
      <div class$="dropdown-trigger [[stateColor]] sucursal_hours paper-font-body1 layout horizontal center">
        <iron-icon icon="schedule"></iron-icon>
        <div class="title paper-font-body2">[[_getOpenInfo(hoursOpen)]]</div>
        <iron-icon icon="arrow-drop-down"></iron-icon>
      </div>
      <div class="dropdown-content">
        <template is="dom-repeat" items="[[orderHours(hoursOpen)]]" as="day">
          <div class="paper-font-body2 day_name">[[day.name]]</div>
          <!-- Muestra un mensaje de cerrado si ese día no hay horarios -->
          <template is="dom-if" if="[[!_hasItems(day.hours)]]">
            <div class="paper-font-body1">Cerrado</div>
          </template>
          <!-- Si existen horarios, los recorre y los muestra -->
          <template is="dom-repeat" items="[[_sortByHours(day.hours)]]" as="horario">
            <div class="paper-font-body1">[[formatTime(horario.start)]] - [[formatTime(horario.finish)]]</div>
          </template>
        </template>
      </div>
    </paper-menu-button>

  </template>
  <script>
    Polymer({
      is: "business-hours",
      properties: {
        hoursOpen: Object,
        openedText: String,
        openingPrefix: String,
        closedText: String,
        closingPrefix: String
      },
      formatTime: function (time) {
        return moment(time, 'HH:mm').format("h:mm A");
      },
      orderHours: function (hoursOpen) {
        //Ordenar desde el día de hoy en adelante
        var offset = moment().weekday();
        var newArray = [];
        for (var i = 0; i < hoursOpen.length; i++) {
          newArray.push(hoursOpen[(offset+i)%hoursOpen.length]);
        }
        return newArray;
      },
      _getOpenInfo: function (hoursOpen) {
        var isOpenNow = false;
        var timeToOpen = "";
        var timeToClose = "";

        for (var i = 0; i < hoursOpen.length; i++) {
          var todayHours = hoursOpen[i];
          var dayName = todayHours.name.toLowerCase();

          for (var j = 0; j < todayHours.hours.length; j++) {
            var hourRange = todayHours.hours[j];
            var openingHours = moment(hourRange.start, 'HH:mm').day(dayName);
            var closingHours = moment(hourRange.finish, 'HH:mm').day(dayName);

            if ((openingHours.hour() >=12 && closingHours.hour() <=12 ) || closingHours.isBefore(openingHours)) {
              closingHours.add(1, "days");
              if (moment().hour() <=12 ) {
                moment().add(1, "days");
              }
            }

            // Si está abierto en el momento, muestra en cuánto tiempo cerrará si faltan menos de 2 horas
            if (moment().isBetween(openingHours, closingHours)) {
              isOpenNow = true;
              if (closingHours.diff(moment(), "hours") >= 0 && closingHours.diff(moment(), "hours") < 2) {
                timeToClose = moment.duration(closingHours.diff(moment())).humanize();
              }
            } else { // Si no está abierto en el momento, muestra en cuánto tiempo abrirá si faltan menos de 2 horas
              if (openingHours.diff(moment(), "hours") >= 0 && openingHours.diff(moment(), "hours") < 2) {
                timeToOpen = moment.duration(openingHours.diff(moment())).humanize();
              }
            }
          }
        }
        if (isOpenNow) {
          if (timeToClose) {
            this.stateColor = "yellow";
            return this.closingPrefix + ' ' + timeToClose;
          } else {
            this.stateColor = "green";
            return this.openedText;
          }
        } else{
          if (timeToOpen) {
            this.stateColor = "grey";
            return this.openingPrefix + ' ' + timeToOpen;
          } else {
            this.stateColor = "red";
            return this.closedText;
          }
        }
      },
      _hasItems: function (array) {
        return array.length > 0;
      },
      _sortByHours: function (array) {
        return array.sort(function(a,b) {
          return (moment(a.start, 'HH:mm') > moment(b.start, 'HH:mm')) ? 1 : ((moment(b.start, 'HH:mm') > moment(a.start, 'HH:mm')) ? -1 : 0);
        });
      }
    })
  </script>
</dom-module>
