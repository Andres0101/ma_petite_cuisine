<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../bower_components/alijaya-masonry/alijaya-masonry.html">
<link rel="import" href="elements/usuario/qualification-card.html">
<link rel="import" href="shared-styles.html">

<dom-module id="calificaciones-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
      }

      .module_title {
        padding: 32px 5px;
        color: var(--secondary-text-color);
      }

      paper-menu-button {
        --paper-menu-button: {
          padding-right: 0;
        }
        --paper-menu-button-dropdown: {
          margin-top: 50px;
        }
        --paper-menu-button-content:{
          cursor: pointer;
        }
      }

      iron-icon {
        --iron-icon-fill-color: #757575;
      }
      .textOrderBy {
        color: #757575;
      }

      @media (max-width: 900px) {
        .module_title {
          font-size: 18px;
        }
      }
      @media (max-width: 400px) {
        .module_title {
          padding-left: 16px;
        }
      }
    </style>

    <iron-localstorage
      id="localstorage"
      name="my-app-storage"
      value="{{userInfo}}"
      on-iron-localstorage-load="_localStorageLoad"
      on-iron-localstorage-load-empty="_onLocalStorageEmpty">
    </iron-localstorage>

    <iron-ajax
      id="ajax"
      url="http://localhost:8000/api/v1/rating-by-user"
      on-response="handleResponse">
    </iron-ajax>

    <!-- 3 Columnas -->
    <iron-media-query query="(max-width: 900px)" query-matches="{{threeColumns}}" on-query-matches-changed="_resizeMasonry"></iron-media-query>
    <!-- 2 Columnas -->
    <iron-media-query query="(max-width: 700px)" query-matches="{{twoColumns}}" on-query-matches-changed="_resizeMasonry"></iron-media-query>

    <div class="layout horizontal center">
      <div class="module_title paper-font-title">Calificaciones</div>
      <span class="flex"></span>
      <paper-menu-button horizontal-align="right">
        <paper-button class="dropdown-trigger" tabindex="0">
          <iron-icon icon="sort"></iron-icon>
          <span class="textOrderBy">Ordenar por</span>
        </paper-button>

        <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{sortVal}}">
          <paper-item value="rating">Más populares</paper-item>
          <paper-item value="oldest">Más antiguos</paper-item>
          <paper-item value="newest">Más nuevos</paper-item>
        </paper-menu>
      </paper-menu-button>
    </div>

    <alijaya-masonry id="masonry" cols="{{col}}" gutter="10">
      <template is="dom-repeat" items="{{data}}" as="calificacion" sort="{{_sort(sortVal)}}">
        <alijaya-masonry-item>
          <qualification-card
            image="[[_generateImage(calificacion.image)]]"
            title="[[calificacion.name]]"
            rating="[[calificacion.rating]]"
            description="[[calificacion.description]]"
            date="[[calificacion.date]]">
          </qualification-card>
        </alijaya-masonry-item>
      </template>
    </alijaya-masonry>

  </template>

  <script>
    Polymer({
      is: 'calificaciones-view',

      properties: {
        col: {
          type: String,
          value: "5"
        }
      },

      attached: function() {
        this.fire('show-progress', true);

        this._updateMasonryStyles = this._updateMasonryStyles || function() {
          this.$.masonry.layout();
        }.bind(this);
        window.addEventListener('resize', this._updateMasonryStyles);
      },
      detached: function() {
        window.removeEventListener('resize', this._updateMasonryStyles);
      },

      _localStorageLoad: function () {
        this.$.ajax.params = {
          'id': this.userInfo.user.id,
          'token': this.userInfo.token
        };
        this.$.ajax.generateRequest();
      },

      handleResponse: function (response) {
        this.fire('show-progress', false);
        this.data = response.detail.response;
      },

      _generateImage: function (image) {
        return "http://localhost:8000" + image;
      },

      _resizeMasonry: function () {
        this.async(function () {
          if (this.threeColumns && !this.twoColumns) {
            this.col = "3";
          } else if (this.threeColumns && this.twoColumns) {
            this.col = "2";
          } else {
            this.col = "4";
          }
        }, 50);
      },

      _sort: function(val) {
        this.async(function () {
          this.$.masonry.layout();
        }, 100);
        switch(val) {
          case 'rating':
            return function(a, b) {
              return a.rating < b.rating;
            };
          case 'oldest':
            return function(a, b) {
              if (a.date === b.date) return 0;
              return a.date < b.date ? -1 : 1;
            };
          case 'newest':
            return function(a, b) {
              if (a.date === b.date) return 0;
              return a.date > b.date ? -1 : 1;
            };
        }
      }
    });
  </script>
</dom-module>
